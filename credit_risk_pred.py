# -*- coding: utf-8 -*-
"""Task 3 Chase.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1GIguN41D0acml2fwIzyYbKwfAA1ALc8w
"""

import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import RandomForestClassifier, GradientBoostingClassifier
from sklearn.metrics import roc_auc_score, classification_report
import warnings
import os
warnings.filterwarnings('ignore')

df = pd.read_csv('/content/Task 3 and 4_Loan_Data.csv')

if df is None:
    raise FileNotFoundError("CSV file not found. Please upload the file first.")

X = df.drop(['customer_id', 'default'], axis=1)
y = df['default']

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)

scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

log_reg = LogisticRegression(random_state=42, max_iter=1000)
log_reg.fit(X_train_scaled, y_train)

rf_model = RandomForestClassifier(n_estimators=100, random_state=42, max_depth=10)
rf_model.fit(X_train, y_train)

gb_model = GradientBoostingClassifier(n_estimators=100, random_state=42, max_depth=5, learning_rate=0.1)
gb_model.fit(X_train, y_train)

log_reg_auc = roc_auc_score(y_test, log_reg.predict_proba(X_test_scaled)[:, 1])
rf_auc = roc_auc_score(y_test, rf_model.predict_proba(X_test)[:, 1])
gb_auc = roc_auc_score(y_test, gb_model.predict_proba(X_test)[:, 1])

print(f"Logistic Regression AUC: {log_reg_auc:.4f}")
print(f"Random Forest AUC: {rf_auc:.4f}")
print(f"Gradient Boosting AUC: {gb_auc:.4f}")

def predict_default_probability(credit_lines_outstanding, loan_amt_outstanding,
                                  total_debt_outstanding, income,
                                  years_employed, fico_score, model='logistic'):
    input_data = pd.DataFrame({
        'credit_lines_outstanding': [credit_lines_outstanding],
        'loan_amt_outstanding': [loan_amt_outstanding],
        'total_debt_outstanding': [total_debt_outstanding],
        'income': [income],
        'years_employed': [years_employed],
        'fico_score': [fico_score]
    })

    if model == 'logistic':
        input_scaled = scaler.transform(input_data)
        prob_default = log_reg.predict_proba(input_scaled)[0, 1]
    elif model == 'random_forest':
        prob_default = rf_model.predict_proba(input_data)[0, 1]
    elif model == 'gradient_boosting':
        prob_default = gb_model.predict_proba(input_data)[0, 1]
    else:
        raise ValueError("Model must be 'logistic', 'random_forest', or 'gradient_boosting'")

    return prob_default

def calculate_expected_loss(credit_lines_outstanding, loan_amt_outstanding,
                             total_debt_outstanding, income,
                             years_employed, fico_score,
                             loan_amount, recovery_rate=0.10, model='logistic'):
    pd = predict_default_probability(credit_lines_outstanding, loan_amt_outstanding,
                                      total_debt_outstanding, income,
                                      years_employed, fico_score, model)

    lgd = 1 - recovery_rate
    ead = loan_amount
    expected_loss = pd * lgd * ead

    return expected_loss

sample_borrower = X_test.iloc[0]
print(f"\nSample Borrower Features:")
print(sample_borrower)

prob_default = predict_default_probability(
    sample_borrower['credit_lines_outstanding'],
    sample_borrower['loan_amt_outstanding'],
    sample_borrower['total_debt_outstanding'],
    sample_borrower['income'],
    sample_borrower['years_employed'],
    sample_borrower['fico_score'],
    model='logistic'
)

print(f"\nProbability of Default: {prob_default:.4f}")

loan_amount = 10000
expected_loss = calculate_expected_loss(
    sample_borrower['credit_lines_outstanding'],
    sample_borrower['loan_amt_outstanding'],
    sample_borrower['total_debt_outstanding'],
    sample_borrower['income'],
    sample_borrower['years_employed'],
    sample_borrower['fico_score'],
    loan_amount=loan_amount,
    recovery_rate=0.10,
    model='logistic'
)

print(f"Expected Loss on ${loan_amount:,.0f} loan: ${expected_loss:.2f}")

print("\nComparison across models:")
for model_name in ['logistic', 'random_forest', 'gradient_boosting']:
    el = calculate_expected_loss(
        sample_borrower['credit_lines_outstanding'],
        sample_borrower['loan_amt_outstanding'],
        sample_borrower['total_debt_outstanding'],
        sample_borrower['income'],
        sample_borrower['years_employed'],
        sample_borrower['fico_score'],
        loan_amount=loan_amount,
        recovery_rate=0.10,
        model=model_name
    )
    print(f"{model_name.replace('_', ' ').title()}: ${el:.2f}")